---
title: "explore_neighborhood_characteristics"
author: "Anaïs Ladoy"
date: '2023-04-17'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/mnt/data/GEOSAN/RESEARCH PROJECTS/GEOCHRONIC @ LASIG (EPFL)/GEOSAN-geochronic/src")
```

```{r, include=FALSE}
library(stats)
library(tmap)
library(leaflet)
require(RPostgreSQL)
library(corrplot)
library(spdep)
library(rgeoda)
library(sf)
library(tidyverse)
source('/mnt/data/GEOSAN/FUNCTIONS/GIRAPH-functions/geosan_funcs/password_utils.R')
source('descriptive/utils_explore_neighborhood_characteristics.R')
```


```{r, include=FALSE}
con <- dbConnect(drv=RPostgreSQL::PostgreSQL(),host = "localhost",user= "aladoy","deep-rene",dbname="geosan")
```

### Import the datasets


- `boundary.laus`: Boundary of the Lausanne area (polygon)
- `boundary.vd`: Boundary of the Vaud state (polygon)

```{r, include=FALSE}
boundary.laus <- read_sf(con, query="SELECT * FROM lausanne_sectors_extent")
sectors.laus <- read_sf(con, query="SELECT * FROM lausanne_sectors")
boundary.vd <- read_sf(con, query="SELECT * FROM vd_canton")
```

- `env`: Indicators from Commune-en-Santé project

```{r, include=FALSE}
env.sf <- read_sf(con, query="SELECT reli, ptot, d_sport, d_forest, d_lake, d_swim, n_acc_ped, n_acc_bic, green_sp, blue_sp, pm25, no2, noise, env_index, soc_eco_index, healthcare_index, rp65m, r_pla, medrev, r_div_wid, r_ffb, r_nn_fra, r_nn_pobl, r_dis, r_unemp, geometry FROM ha_indicators")
```

- `socdemo`: Indicators from MicroGIS that will be used as proxy of individual-level covariates

```{r, include=FALSE}
sql_socdemo = "SELECT reli, ptot_x as ptot, (p4549f + p5054f) as p4554f, (p5559f + p6064f) as p5564f, (p6569f + p7074f) as p6574f, (p7579f + p8084f + p8589f + p90mf) as p75mf, (p4549m + p5054m) as p4554m, 
(p5559m + p6064m) as p5564m, (p6569m + p7074m) as p6574m, (p7579m + p8084m + p8589m + p90mm) as p75mm,hhp1p as hhp1p,hhpriv as hhpriv, (pnschb + pnschn) as pswiss,adune as punemployed,(pfnone + pfobl + pfgen + pfprof) as ploweduc, (pfmat + pfprsf + pfprss) as pmededuc, (pfbac + pfmas + pfphd) as phigheduc, iqmd as medincome FROM microgis_ha"
socdemo <- read_sf(con, query=sql_socdemo)
```


### Data Wrangling

Create neighborhood-level proxies for individual-level covariates.
```{r, include=FALSE}
socdemo <- socdemo %>% mutate(
  F_45_54 = perc(p4554f, ptot),
  F_55_64 = perc(p5564f, ptot),
  F_65_74 = perc(p6574f, ptot),
  F_75_MORE = perc(p75mf, ptot),
  M_45_54 = perc(p4554m, ptot),
  M_55_64 = perc(p5564m, ptot),
  M_65_74 = perc(p6574m, ptot),
  M_75_MORE = perc(p75mm, ptot),
  SWISS = perc(pswiss, ptot),
  UNEMPLOYMENT = perc(punemployed, ptot),
  LOW_EDUC = perc(ploweduc, ptot),
  MEDIUM_EDUC = perc(pmededuc, ptot),
  HIGH_EDUC = perc(phigheduc, ptot),
  INCOME = medincome,
  POVERTY = factor(if_else(medincome < 40, 1 , 0)), #https://www.swissinfo.ch/eng/society/poverty-affects-nearly-one-in-five-swiss-households/47370330
  HH_1PERS = perc(hhp1p, hhpriv)
) %>%
  select(reli, F_45_54:HH_1PERS)
```

Select environmental variables
```{r}
env.sf <- env.sf %>% 
  # select(reli, ptot, d_sport, n_acc_ped, green_sp, pm25, no2, noise, env_index, soc_eco_index) %>% 
  rename_at(vars(-reli, -geometry), toupper)
```

Merge socio-eco and environmental covariates
```{r}
neighborhood.vd.sf <- env.sf %>%
  inner_join(socdemo, by="reli") %>%
  na.omit()
```

Save
```{r}
st_write(neighborhood.vd.sf, "../processed_data/neighborhood_vd.gpkg", delete_dsn = TRUE)
```

Create a subset for Lausanne's neighborhoods
```{r, include=FALSE}
neighborhood.laus.sf <- neighborhood.vd.sf %>% st_filter(boundary.laus$geometry, .predicates = st_intersects)
```



### Explore correlations between variables

**Pearson's correlation**

Vaud
```{r}
corr.vd <- compute_corr_matrix(neighborhood.vd.sf %>% st_drop_geometry() %>% select(-c("reli", "POVERTY")))
print_highly_correlated_vars(corr.vd, threshold = 0.7)
```
Lausanne
```{r}
corr.laus <- compute_corr_matrix(neighborhood.laus.sf %>% st_drop_geometry() %>% select(-c("reli", "POVERTY")))
print_highly_correlated_vars(corr.laus, threshold = 0.7)
```
The same patterns are observed between Vaud state and Lausanne city if we consider a 0.7 threshold.

*For socio-demographic / economic characteristics:* we keep both the composite index (SOC_ECO_INDEX) and the standalone variables since they seem to bring different informations.  
*For environmental characteristics:* we keep the composite index of environmental exposures (ENV_INDEX) over the air pollution and noise variables due to highly correlated variables. We also consider the population density (PTOT), accessibility to sport facilities (D_SPORT), area's greenspace (GREEN_SP), and pedestrian accidents (N_ACC_PED) to quantify walkability, housing, and landscape.

Drop air pollutants and noise
```{r}
neighborhood.vd.sf <- neighborhood.vd.sf %>% select(-c(PM25, NO2, NOISE))
neighborhood.laus.sf <- neighborhood.laus.sf %>% select(-c(PM25, NO2, NOISE))
```


### Explore global and local clustering

**Define spatial weights**

Distance-based Weights
```{r}
W.dist <- create_distance_weights(neighborhood.laus.sf, 300)
summary(W.dist$rgeoda)
```

Queen Contiguity Weights
```{r}
W.queen <- create_queen_weights(neighborhood.laus.sf)
summary(W.queen$rgeoda)
```


**Global & Local spatial autocorrelation (Moran's I)**

```{r, include=FALSE}
run_spatial_autocorr <- function(w, sf, var_name, boundary.sf){
  
  I <- compute_global_moran(w$spdep, sf, var_name)
  
  lisa <- compute_local_moran(w$rgeoda, sf, var_name,  nperms=9999, cutoff=0.05, ncpu=12, adjust="fdr")
  
  plot_lisa(lisa, boundary.sf, var_name, I, interactive=FALSE)

}

```

PTOT
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "PTOT", sectors.laus)
run_spatial_autocorr(W.queen, neighborhood.laus.sf, "PTOT", sectors.laus)
```

D_SPORT
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "D_SPORT", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "D_SPORT", sectors.laus)
```

N_ACC_PED
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "N_ACC_PED", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "N_ACC_PED", sectors.laus)
```

GREEN_SP
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "GREEN_SP", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "GREEN_SP", sectors.laus)
```

ENV_INDEX
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "ENV_INDEX", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "ENV_INDEX", sectors.laus)
```


SOC_ECO_INDEX
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "SOC_ECO_INDEX", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "SOC_ECO_INDEX", sectors.laus)
```

INCOME
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "INCOME", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "INCOME", sectors.laus)
```


F_75_MORE
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "F_75_MORE", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "F_75_MORE", sectors.laus)
```

M_75_MORE
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "M_75_MORE", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "M_75_MORE", sectors.laus)
```

SWISS
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "SWISS", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "SWISS", sectors.laus)
```


UNEMPLOYMENT
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "UNEMPLOYMENT", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "UNEMPLOYMENT", sectors.laus)
```

LOW_EDUC
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "LOW_EDUC", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "LOW_EDUC", sectors.laus)
```
HIGH_EDUC
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "HIGH_EDUC", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "HIGH_EDUC", sectors.laus)
```

HH_1PERS
```{r}
run_spatial_autocorr(W.dist, neighborhood.laus.sf, "HH_1PERS", sectors.laus)
# run_spatial_autocorr(W.queen, neighborhood.laus.sf, "HH_1PERS", sectors.laus)
```




