---
title: "model_empirical_prevalence"
author: "Anaïs Ladoy"
date: '2023-04-13'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/mnt/data/GEOSAN/RESEARCH PROJECTS/GEOCHRONIC @ LASIG (EPFL)/GEOSAN-geochronic/src")
```

```{r, include=FALSE}
library(stats)
library(tmap)
library(leaflet)
library(lme4)
require(RPostgreSQL)
library(MASS)
library(MapGAM)
library(corrplot)
library(pROC)
library(corrplot)
library(mgcv)
library(gam)
library(caret)
library(jtools)
library(rgeoda)
library(PrevMap)
library(sf)
library(tidyverse)
source('/mnt/data/GEOSAN/FUNCTIONS/GIRAPH-functions/geosan_funcs/password_utils.R')
```




```{r, include=FALSE}
con <- dbConnect(drv=RPostgreSQL::PostgreSQL(),host = "localhost",user= "aladoy",rstudioapi::askForPassword(),dbname="geosan")
```


### Import the datasets

- `data.all`: All F2 Colaus participants eligible for this study (see selection procedure).

```{r, include=FALSE}
data.sf <- read_sf(con, query="SELECT *, ST_X(geometry) as coordx, ST_Y(geometry) as coordy FROM geochronic.f2_study_dataset")
```

- `boundary.laus`: Boundary of the Lausanne area (polygon)
- `boundary.vd`: Boundary of the Vaud state (polygon)

```{r, include=FALSE}
boundary.laus <- read_sf(con, query="SELECT * FROM lausanne_sectors_extent")
boundary.vd <- read_sf(con, query="SELECT * FROM vd_canton")
```

- `env`: Indicators from Commune-en-Santé project

```{r, include=FALSE}
env.sf <- read_sf(con, query="SELECT reli, ptot, d_sport, d_forest, d_lake, d_swim, n_acc_ped, n_acc_bic, green_sp, blue_sp, pm25, no2, noise, env_index, soc_eco_index, healthcare_index, geometry FROM ha_indicators")
```

- `socdemo`: Indicators from MicroGIS that will be used as proxy of individual-level covariates

```{r}
sql_socdemo = "SELECT reli, ptot_x as ptot, (p4549f + p5054f) as p4554f, (p5559f + p6064f) as p5564f, (p6569f + p7074f) as p6574f, (p7579f + p8084f + p8589f + p90mf) as p75mf, (p4549m + p5054m) as p4554m, 
(p5559m + p6064m) as p5564m, (p6569m + p7074m) as p6574m, (p7579m + p8084m + p8589m + p90mm) as p75mm,hhp1p as hhp1p,hhpriv as hhpriv, (pnschb + pnschn) as pswiss,adune as punemployed,(pfnone + pfobl + pfgen + pfprof) as ploweduc, (pfmat + pfprsf + pfprss) as pmededuc, (pfbac + pfmas + pfphd) as phigheduc, iqmd as medincome FROM microgis_ha"
socdemo <- read_sf(con, query=sql_socdemo)
```


### Data Wrangling

Create neighborhood-level proxies for individual-level covariates.
```{r}
socdemo <- socdemo %>% mutate(
  F_45_54 = perc(p4554f, ptot),
  F_55_64 = perc(p5564f, ptot),
  F_65_74 = perc(p6574f, ptot),
  F_75_MORE = perc(p75mf, ptot),
  M_45_54 = perc(p4554m, ptot),
  M_55_64 = perc(p5564m, ptot),
  M_65_74 = perc(p6574m, ptot),
  M_75_MORE = perc(p75mm, ptot),
  SWISS = perc(pswiss, ptot),
  UNEMPLOYMENT = perc(punemployed, ptot),
  LOW_EDUC = perc(ploweduc, ptot),
  MEDIUM_EDUC = perc(pmededuc, ptot),
  HIGH_EDUC = perc(phigheduc, ptot),
  POVERTY = factor(if_else(medincome < 40, 1 , 0)), #https://www.swissinfo.ch/eng/society/poverty-affects-nearly-one-in-five-swiss-households/47370330
  HH_1PERS = perc(hhp1p, hhpriv)
) %>%
  select(reli, F_45_54:HH_1PERS)
```

Select environmental variables
```{r}
env.sf <- env.sf %>% 
  select(reli, ptot, d_sport, n_acc_ped, green_sp, pm25, no2, noise, env_index, soc_eco_index) %>% 
  rename_at(vars(-matches('reli')), toupper)
```

Filter data from Lausanne only
```{r, include=FALSE}
data.sf <- data.sf %>% st_filter(boundary.laus$geometry, .predicates = st_intersects)
env.sf <- env.sf %>% st_filter(boundary.laus$geometry, .predicates = st_intersects)
```

Convert to non-spatial dataframe
```{r, include=FALSE}
data <- data.sf %>% st_drop_geometry()
```

Merge data with environmental covariates
```{r}
data <- left_join(data, env.sf %>% st_drop_geometry(), by="reli")
paste("Number of participants removed because no covariate data for corresponding RELI: ", data %>% filter(is.na(D_SPORT)) %>% nrow())
data <- data %>% filter(!is.na(D_SPORT))
```
Compute prevalence per RELI
```{r}
data.prev <- data %>% group_by(reli) %>% summarise(NCASES = sum(diabetes), NINDIV=n())
# data.prev <- data.prev %>% mutate(emp_log_prev = (n_cases+0.5) / (n_indiv + 0.5))
data.prev$ELOGIT <- log((data.prev$NCASES+0.5)/(data.prev$NINDIV-data.prev$NCASES+0.5))
```

```{r}
data.prev <- data.prev %>% 
  inner_join(socdemo, by="reli") %>% 
  inner_join(env.sf %>% st_drop_geometry(), by="reli")
```


### Explore neighborhood characteristics


Linear relationship between neighborhood characteristics
```{r}
corr <- compute_corr_matrix(data.prev %>% select(-c("reli", "NINDIV", "POVERTY")))
print_highly_correlated_vars(corr, threshold = 0.7)
```





```{r}


# Plot relationship between elevation and number of infected
plot(data.prev$soc_eco_index,data.prev$elogit,
     xlab="UNEMPLOYMENT", ylab="Empirical logit")

```


```{r}
summary(data.prev$emp_log_prev)
```

```{r}
glm.fit1 <- glm(cbind(n_cases,n_indiv-n_cases) ~ F_75_MORE + M_75_MORE + SWISS + UNEMPLOYMENT + LOW_EDUC + MEDIUM_EDUC + HIGH_EDUC + POVERTY + HH_1PERS + env_index + soc_eco_index, data = data.prev,family = binomial) %>% stepAIC(direction="backward")
summary(glm.fit1)
```


Compute Empirical logit prevalence
```{r}
log((data.sf$NO_INF+0.5)/(data.sf$NO_EXAM-loaloa$NO_INF+0.5))
```


